{% extends "base.html" %}

{% block title %}ì‘ì—… ì‹¤í–‰{% endblock %}

{% block content %}
<div class="mt-4 mb-3">
    <h2>ì‘ì—… ì‹¤í–‰</h2>
    <p>ì•„ë˜ì—ì„œ ì €ì¥ëœ ì„¤ì •ì„ ì„ íƒí•˜ê³  ì‘ì—…ì„ ì‹¤í–‰í•˜ì„¸ìš”.</p>
</div>

<div class="card">
    <div class="card-body">
        <div class="mb-3">
            <label for="settingSelect" class="form-label"><strong>1. ì„¤ì • ì„ íƒ</strong></label>
            <select class="form-select" id="settingSelect">
                <option selected disabled>ì‹¤í–‰í•  ì„¤ì •ì„ ì„ íƒí•˜ì„¸ìš”...</option>
                {% for setting in settings %}
                <option value="{{ setting.id }}">{{ setting.title }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
</div>

<!-- ì„¤ì • ìƒì„¸ ì •ë³´ ë° ì‘ì—… ë²„íŠ¼ -->
<div class="card mt-4" id="settingDetailsContainer" style="display: none;">
    <div class="card-header">
        <h5><strong>2. ì„¤ì • ì •ë³´ í™•ì¸ ë° ì‘ì—… ì‹¤í–‰</strong></h5>
    </div>
    <div class="card-body">
        <div id="settingDetails"></div>
        <div id="settingEditButtons" class="mb-3" style="display: flex; gap: 10px;">
            <button class="btn btn-outline-secondary btn-sm" id="editBtn">ìˆ˜ì •</button>
        </div>
        <div id="settingEditFormContainer" style="display: none;"></div>
        <hr>
        <div class="btn-group w-100">
            <button class="btn btn-success" onclick="runJob('create_table')">ğŸ“‹ í…Œì´ë¸” ìƒì„±</button>
            <button class="btn btn-primary" onclick="runJob('append_data')">â• ë°ì´í„° ì¶”ê°€</button>
            <button class="btn btn-warning" onclick="runJob('update_data')">ğŸ”„ ë°ì´í„° ë®ì–´ì“°ê¸°</button>
        </div>
    </div>
</div>

<!-- ì‘ì—… ê²°ê³¼ -->
<div class="card mt-4" id="resultCard" style="display: none;">
    <div class="card-header">
        <h4>ì‘ì—… ê²°ê³¼</h4>
    </div>
    <div class="card-body">
        <div id="loading" style="display: none;" class="text-center">
            <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">ì‘ì—…ì„ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
        <div id="result"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentSetting = null;
    let schemaFiles = {{ schema_files|tojson if schema_files is defined else '[]' }};

    document.getElementById('settingSelect').addEventListener('change', async function() {
        const settingId = this.value;
        const detailsContainer = document.getElementById('settingDetailsContainer');
        const detailsDiv = document.getElementById('settingDetails');
        const editBtns = document.getElementById('settingEditButtons');
        const editFormContainer = document.getElementById('settingEditFormContainer');
        document.getElementById('resultCard').style.display = 'none';
        editFormContainer.style.display = 'none';
        editFormContainer.innerHTML = '';

        if (!settingId || isNaN(settingId)) {
            detailsContainer.style.display = 'none';
            return;
        }

        try {
            const response = await fetch(`/api/settings/${settingId}`);
            if (!response.ok) throw new Error('ì„¤ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            currentSetting = await response.json();
            detailsDiv.innerHTML = renderSettingDetails(currentSetting);
            detailsContainer.style.display = 'block';
            editBtns.style.display = 'flex';
        } catch (error) {
            alert(error.message);
            detailsContainer.style.display = 'none';
        }
    });

    function renderSettingDetails(setting) {
        return `
            <dl class="row">
                <dt class="col-sm-3">íƒ€ì´í‹€</dt>
                <dd class="col-sm-9">${setting.title}</dd>
                <dt class="col-sm-3">ì‹œíŠ¸ ID</dt>
                <dd class="col-sm-9">${setting.sheet_id}</dd>
                <dt class="col-sm-3">í—¤ë” ë²”ìœ„</dt>
                <dd class="col-sm-9">${setting.header_range}</dd>
                <dt class="col-sm-3">ë°ì´í„° ë²”ìœ„</dt>
                <dd class="col-sm-9">${setting.data_range}</dd>
                <dt class="col-sm-3">BQ í…Œì´ë¸” ID</dt>
                <dd class="col-sm-9">${setting.bq_table_id}</dd>
                <dt class="col-sm-3">ìŠ¤í‚¤ë§ˆ íŒŒì¼</dt>
                <dd class="col-sm-9">${setting.schema_csv}</dd>
            </dl>
        `;
    }

    function renderSettingForm(setting = null) {
        return `
        <form id="inlineSettingForm">
            <div class="mb-2">
                <label class="form-label">íƒ€ì´í‹€</label>
                <input type="text" class="form-control" name="title" value="${setting ? setting.title : ''}" required>
            </div>
            <div class="mb-2">
                <label class="form-label">ì‹œíŠ¸ ID</label>
                <input type="text" class="form-control" name="sheet_id" value="${setting ? setting.sheet_id : ''}" required>
            </div>
            <div class="row">
                <div class="col-md-6 mb-2">
                    <label class="form-label">í—¤ë” ë²”ìœ„</label>
                    <input type="text" class="form-control" name="header_range" value="${setting ? setting.header_range : ''}" required>
                </div>
                <div class="col-md-6 mb-2">
                    <label class="form-label">ë°ì´í„° ë²”ìœ„</label>
                    <input type="text" class="form-control" name="data_range" value="${setting ? setting.data_range : ''}" required>
                </div>
            </div>
            <div class="mb-2">
                <label class="form-label">BQ í…Œì´ë¸” ID</label>
                <input type="text" class="form-control" name="bq_table_id" value="${setting ? setting.bq_table_id : ''}" required>
            </div>
            <div class="mb-2">
                <label class="form-label">ìŠ¤í‚¤ë§ˆ íŒŒì¼</label>
                <select class="form-select" name="schema_csv" required>
                    <option value="" disabled ${!setting || !setting.schema_csv ? 'selected' : ''}>ì—…ë¡œë“œëœ ìŠ¤í‚¤ë§ˆ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”...</option>
                    ${schemaFiles.map(f => `<option value="${f}" ${(setting && setting.schema_csv === f) ? 'selected' : ''}>${f}</option>`).join('')}
                </select>
            </div>
            <div class="mt-2" style="display: flex; gap: 10px;">
                <button type="submit" class="btn btn-success btn-sm">ì €ì¥</button>
                <button type="button" class="btn btn-secondary btn-sm" id="cancelEditBtn">ì·¨ì†Œ</button>
            </div>
        </form>
        `;
    }

    // ìˆ˜ì • ë²„íŠ¼
    document.getElementById('editBtn').onclick = function() {
        const editFormContainer = document.getElementById('settingEditFormContainer');
        editFormContainer.innerHTML = renderSettingForm(currentSetting);
        editFormContainer.style.display = 'block';
        document.getElementById('settingEditButtons').style.display = 'none';
        bindInlineForm('edit');
    };

    function bindInlineForm(mode) {
        const form = document.getElementById('inlineSettingForm');
        document.getElementById('cancelEditBtn').onclick = function() {
            form.parentElement.style.display = 'none';
            document.getElementById('settingEditButtons').style.display = 'flex';
        };
        form.onsubmit = async function(e) {
            e.preventDefault();
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            let url, method;
            if (mode === 'edit') {
                url = `/api/settings/${currentSetting.id}`;
                method = 'PATCH';
            } else {
                url = '/api/settings';
                method = 'POST';
            }
            try {
                const response = await fetch(url, {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                const result = await response.json();
                if (result.success) {
                    alert('ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    // ë“œë¡­ë‹¤ìš´, ìƒì„¸ì •ë³´, ë²„íŠ¼ ëª¨ë‘ ê°±ì‹ 
                    location.reload();
                } else {
                    alert('ì €ì¥ ì‹¤íŒ¨: ' + (result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'));
                }
            } catch (err) {
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜: ' + err.message);
            }
        };
    }

    async function runJob(jobName) {
        const settingSelect = document.getElementById('settingSelect');
        const settingId = settingSelect.value;

        if (!settingId || isNaN(settingId)) {
            alert('ë¨¼ì € ì‹¤í–‰í•  ì„¤ì •ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            return;
        }

        const resultCard = document.getElementById('resultCard');
        const resultDiv = document.getElementById('result');
        const loadingDiv = document.getElementById('loading');

        resultCard.style.display = 'block';
        loadingDiv.style.display = 'block';
        resultDiv.innerHTML = '';

        try {
            const response = await fetch(`/run_job/${jobName}/${settingId}`, {
                method: 'POST',
            });
            const data = await response.json();
            
            let resultHtml = '';
            if (data.success) {
                resultHtml = `<div class="alert alert-success">`;
                resultHtml += `<strong>ì„±ê³µ:</strong> ${data.details.message}<br>`;
                
                if (data.details.columns_count) {
                    resultHtml += `<strong>ì»¬ëŸ¼ ìˆ˜:</strong> ${data.details.columns_count}<br>`;
                }
                if (data.details.rows_processed) {
                    resultHtml += `<strong>ì²˜ë¦¬ëœ í–‰:</strong> ${data.details.rows_processed}<br>`;
                }
                 resultHtml += `</div>`;
            } else {
                resultHtml = `<div class="alert alert-danger">`;
                resultHtml += `<strong>ì˜¤ë¥˜:</strong> ${data.message}<br>`;
                if (data.error_details) {
                    resultHtml += `<pre><code>${data.error_details}</code></pre>`;
                }
                resultHtml += `</div>`;
            }
            resultDiv.innerHTML = resultHtml;

        } catch (error) {
            resultDiv.innerHTML = `<div class="alert alert-danger"><strong>ì¹˜ëª…ì  ì˜¤ë¥˜:</strong> ${error.toString()}</div>`;
        } finally {
            loadingDiv.style.display = 'none';
        }
    }
</script>
{% endblock %} 